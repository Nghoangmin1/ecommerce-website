@{
    ViewData["Title"] = "Chi tiết sản phẩm";
    var book = ViewBag.Book as Fahasa.Models.Book;
    var relatedBooks = ViewBag.RelatedBooks as List<Fahasa.Models.Book> ?? new List<Fahasa.Models.Book>();
    
    if (book == null)
    {
        <div class="container mt-5">
            <div class="alert alert-danger text-center">
                <h4>Sản phẩm không tồn tại</h4>
                <p>Sản phẩm bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
                <a asp-area="Customer" asp-controller="Category" asp-action="Index" class="btn btn-danger">Quay lại cửa hàng</a>
            </div>
        </div>
        return;
    }

    var finalPrice = book.Price * (1 - book.DiscountPercent / 100m);
    var languageNames = new Dictionary<int, string> { { 0, "Tiếng Việt" }, { 1, "Tiếng Anh" }, { 2, "Tiếng Trung" }, { 3, "Tiếng Nhật" }, { 4, "Tiếng Hàn" }, { 5, "Khác" } };
    var coverTypeNames = new Dictionary<int, string> { { 0, "Bìa mềm" }, { 1, "Bìa cứng" }, { 2, "Bìa bóng" } };
}

<!-- Breadcrumb -->
<div class="bg-light py-3 mb-4 border-bottom">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent p-0 m-0">
                <li class="breadcrumb-item"><a asp-area="Customer" asp-controller="Home" asp-action="Index" class="text-dark">Trang chủ</a></li>
                <li class="breadcrumb-item"><a asp-area="Customer" asp-controller="Category" asp-action="Index" class="text-dark">Cửa hàng sách</a></li>
                <li class="breadcrumb-item active text-danger" aria-current="page">@book.Name</li>
            </ol>
        </nav>
    </div>
</div>

@if (ViewBag.IsInactive == true)
{
    <div class="container mt-3">
        <div class="alert alert-warning border-warning shadow-sm">
            <h5 class="alert-heading font-weight-bold"><i class="bi bi-exclamation-triangle-fill mr-2"></i>Sản phẩm ngừng kinh doanh</h5>
            <p class="mb-0">Sản phẩm này hiện tại đã ngừng kinh doanh và không thể đặt hàng. Bạn có thể xem thông tin chi tiết bên dưới hoặc tham khảo các sản phẩm tương tự.</p>
        </div>
    </div>
}

<div class="container mb-5">
    <div class="row bg-white p-4 shadow-sm rounded">
        <!-- Product Image -->
        <div class="col-md-5 mb-4 mb-md-0">
            <div class="text-center p-3 border rounded" style="background-color: #f9f9f9;">
                @if (!string.IsNullOrEmpty(book.ImageUrl))
                {
                    <img src="@book.ImageUrl" class="img-fluid" alt="@book.Name" style="max-height: 450px;">
                }
                else
                {
                    <div class="d-flex align-items-center justify-content-center text-muted" style="height: 400px; font-size: 5rem; background-color: #eee;">
                        @(book.Name?.FirstOrDefault().ToString().ToUpper() ?? "?")
                    </div>
                }
            </div>
        </div>

        <!-- Product Details -->
        <div class="col-md-7">
            <h2 class="font-weight-bold mb-3 text-dark">@book.Name</h2>
            
            <div class="row mb-3">
                <div class="col-6 text-muted">Nhà cung cấp: <span class="text-primary font-weight-bold">@(book.Publisher?.Name ?? "Đang cập nhật")</span></div>
                <div class="col-6 text-muted">Tác giả: <span class="text-dark font-weight-bold">@(book.Author?.Name ?? "Đang cập nhật")</span></div>
            </div>
            <div class="row mb-3">
                <div class="col-6 text-muted">Nhà xuất bản: <span class="text-dark">@(book.Publisher?.Name ?? "N/A")</span></div>
                <div class="col-6 text-muted">Hình thức bìa: <span class="text-dark">@(coverTypeNames.ContainsKey(book.CoverType) ? coverTypeNames[book.CoverType] : "Khác")</span></div>
            </div>

            <hr>

            <div class="d-flex align-items-end mb-4">
                <h1 class="text-danger font-weight-bold mr-3 mb-0">@finalPrice.ToString("#,##0") đ</h1>
                @if (book.DiscountPercent > 0)
                {
                    <div class="mb-1">
                        <span class="text-muted text-decoration-through mr-2">@book.Price.ToString("#,##0") đ</span>
                        <span class="badge badge-danger">-@book.DiscountPercent%</span>
                    </div>
                }
            </div>

            <!-- Actions -->
            <form method="post" asp-area="Customer" asp-controller="Cart" asp-action="AddToCart" class="mb-4">
                @Html.AntiForgeryToken()
                <input type="hidden" name="bookId" value="@book.Id" />
                
                @if (ViewBag.IsInactive == true)
                {
                    <div class="form-group row align-items-center opacity-50" style="pointer-events: none;">
                        <label class="col-auto col-form-label pt-0 font-weight-bold">Số lượng:</label>
                        <div class="col-auto">
                            <div class="input-group input-group-sm" style="width: 120px;">
                                <div class="input-group-prepend mb-0">
                                    <button class="btn btn-outline-secondary" type="button" disabled>-</button>
                                </div>
                                <input type="text" class="form-control text-center" name="quantity" value="1" disabled>
                                <div class="input-group-append mb-0">
                                    <button class="btn btn-outline-secondary" type="button" disabled>+</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12 mb-2">
                             <button type="button" class="btn btn-secondary btn-lg btn-block font-weight-bold" disabled>
                                <i class="bi bi-cart-x mr-2"></i> Ngừng kinh doanh
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <div class="form-group row align-items-center">
                        <label class="col-auto col-form-label pt-0 font-weight-bold">Số lượng:</label>
                        <div class="col-auto">
                            <div class="input-group input-group-sm" style="width: 120px;">
                                <div class="input-group-prepend mb-0">
                                    <button class="btn btn-outline-secondary" type="button" onclick="decreaseQty()">-</button>
                                </div>
                                <input type="text" class="form-control text-center" name="quantity" id="qtyInput" value="1">
                                <div class="input-group-append mb-0">
                                    <button class="btn btn-outline-secondary" type="button" onclick="increaseQty()">+</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12 mb-2">
                            <div class="row">
                                <div class="col-6 pr-1">
                                    <button type="submit" class="btn btn-outline-danger btn-lg btn-block font-weight-bold">
                                        <i class="bi bi-cart-plus mr-2"></i> Thêm vào giỏ
                                    </button>
                                </div>
                                <div class="col-6 pl-1">
                                    <button type="button" onclick="buyNow()" class="btn btn-danger btn-lg btn-block font-weight-bold">
                                        <i class="bi bi-lightning-fill mr-2"></i> Mua ngay
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </form>

            <div class="alert alert-light border small">
                <ul class="list-unstyled mb-0">
                    <li class="mb-1"><i class="bi bi-check-circle-fill text-success mr-2"></i> Thời gian giao hàng: Giao nhanh và đúng hẹn</li>
                    <li class="mb-1"><i class="bi bi-check-circle-fill text-success mr-2"></i> Chính sách đổi trả: Đổi trả miễn phí toàn quốc</li>
                    <li><i class="bi bi-check-circle-fill text-success mr-2"></i> Chính sách khách sỉ: Ưu đãi khi mua số lượng lớn</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="container mb-5">
    <div class="bg-white p-4 shadow-sm rounded">
        <ul class="nav nav-tabs mb-4" id="bookTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active font-weight-bold" id="desc-tab" data-toggle="tab" href="#desc" role="tab">Mô tả sản phẩm</a>
            </li>
            <li class="nav-item">
                <a class="nav-link font-weight-bold" id="info-tab" data-toggle="tab" href="#info" role="tab">Thông tin chi tiết</a>
            </li>
            <li class="nav-item">
                <a class="nav-link font-weight-bold" id="review-tab" data-toggle="tab" href="#review" role="tab">Đánh giá khách hàng</a>
            </li>
        </ul>
        <div class="tab-content" id="bookTabContent">
            <!-- Description -->
            <div class="tab-pane fade show active" id="desc" role="tabpanel">
                @if (!string.IsNullOrEmpty(book.Description))
                {
                    <p class="text-justify" style="line-height: 1.8;">@Html.Raw(book.Description.Replace("\n", "<br>"))</p>
                }
                else
                {
                    <p class="text-muted font-italic">Chưa có mô tả cho sản phẩm này.</p>
                }
            </div>

            <!-- Specs -->
            <div class="tab-pane fade" id="info" role="tabpanel">
                <table class="table table-striped table-bordered" style="max-width: 600px;">
                    <tbody>
                        <tr><td class="font-weight-bold" style="width: 200px;">Mã hàng</td><td>@book.Id</td></tr>
                        <tr><td class="font-weight-bold">Tên Nhà Cung Cấp</td><td>@book.Publisher?.Name</td></tr>
                        <tr><td class="font-weight-bold">Tác giả</td><td>@book.Author?.Name</td></tr>
                        <tr><td class="font-weight-bold">Năm XB</td><td>@book.PublicationYear</td></tr>
                        <tr><td class="font-weight-bold">Trọng lượng (gr)</td><td>@book.Weight</td></tr>
                        <tr><td class="font-weight-bold">Kích thước</td><td>@(book.Width)x@(book.Height)x@(book.Depth) cm</td></tr>
                        <tr><td class="font-weight-bold">Số trang</td><td>@book.Pages</td></tr>
                        <tr><td class="font-weight-bold">Hình thức</td><td>@(coverTypeNames.ContainsKey(book.CoverType) ? coverTypeNames[book.CoverType] : "Khác")</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Reviews (Simplified for now) -->
            @using Fahasa.Models
            @{
                var reviews = ViewBag.Reviews as List<Review> ?? new List<Review>();
                var averageRating = reviews.Any() ? reviews.Average(r => r.Rating) : 0;
            }
            <div class="tab-pane fade" id="review" role="tabpanel">
                <div class="row">
                    <!-- Rating Summary -->
                    <div class="col-md-4 text-center border-right">
                        <h1 class="display-4 font-weight-bold text-danger">@averageRating.ToString("0.0")/5</h1>
                        <div class="mb-2">
                             @for(int i=1; i<=5; i++) {
                                if(i <= Math.Round(averageRating)) { <i class="bi bi-star-fill text-warning"></i> }
                                else { <i class="bi bi-star text-warning"></i> }
                             }
                        </div>
                        <p class="text-muted">(@reviews.Count đánh giá)</p>
                    </div>
                    <!-- Reviews List -->
                    <div class="col-md-8">
                        @if (reviews.Any())
                        {
                            foreach (var r in reviews)
                            {
                                <div class="mb-3 border-bottom pb-3">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="font-weight-bold">@r.Phone.Substring(0, r.Phone.Length-3)***</h6>
                                        <small class="text-muted">@r.UpdatedAt.ToString("dd/MM/yyyy")</small>
                                    </div>
                                    <div class="mb-2 text-warning" style="font-size: 0.8rem;">
                                        @for(int i=0; i<r.Rating; i++) { <i class="bi bi-star-fill"></i> }
                                    </div>
                                    <p class="m-0">@r.Comment</p>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted">Chưa có đánh giá nào.</p>
                        }
                        
                        <!-- Simple Review Form Trigger -->
                         <button class="btn btn-outline-danger mt-3" type="button" data-toggle="collapse" data-target="#reviewFormCollapse">Viết đánh giá của bạn</button>
                         <div class="collapse mt-3" id="reviewFormCollapse">
                             <div class="card card-body bg-light">
                                 <form id="reviewForm">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="bookId" value="@book.Id">
                                    <div class="form-group">
                                        <label>Số sao:</label>
                                        <select class="form-control" name="rating" style="width: 100px;">
                                            <option value="5">5 Tuyệt vời</option>
                                            <option value="4">4 Hài lòng</option>
                                            <option value="3">3 Bình thường</option>
                                            <option value="2">2 Tạm ổn</option>
                                            <option value="1">1 Tệ</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <input type="text" class="form-control" name="phone" placeholder="Số điện thoại của bạn" required>
                                    </div>
                                    <div class="form-group">
                                        <textarea class="form-control" name="comment" rows="3" placeholder="Nội dung đánh giá" required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-danger">Gửi đánh giá</button>
                                 </form>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Related Products -->
@if (relatedBooks != null && relatedBooks.Any())
{
    <div class="container mb-5">
        <h4 class="font-weight-bold mb-4 border-bottom pb-2 text-uppercase">Sản phẩm liên quan</h4>
        <div class="row">
            @foreach (var rBook in relatedBooks)
            {
                <div class="col-lg-2 col-md-3 col-6 mb-4">
                    <div class="card h-100 border-0 shadow-sm book-card">
                        <a asp-area="Customer" asp-controller="Category" asp-action="Details" asp-route-id="@rBook.Id" class="position-relative d-block overflow-hidden" style="padding-top: 140%;">
                                <img src="@(string.IsNullOrEmpty(rBook.ImageUrl) ? "/customer/img/product/p1.jpg" : rBook.ImageUrl)" 
                                    class="card-img-top position-absolute w-100 h-100" style="top: 0; left: 0; object-fit: contain; padding: 10px;" alt="@rBook.Name">
                        </a>
                        <div class="card-body p-2 text-center">
                            <h6 class="card-title mb-1" style="font-size: 0.9rem;">
                                <a asp-area="Customer" asp-controller="Category" asp-action="Details" asp-route-id="@rBook.Id" class="text-dark text-decoration-none book-title" title="@rBook.Name">
                                    @rBook.Name
                                </a>
                            </h6>
                            <span class="text-danger font-weight-bold">@rBook.Price.ToString("#,##0") đ</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

<style>
    .book-title {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        height: 38px;
    }
    .book-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1) !important; transition: 0.3s; }
</style>

@section Scripts {
    <script>
        function buyNow() {
            var qty = document.getElementById('qtyInput').value;
            // Validate quantity
            if(qty < 1) {
                toastr.error('Số lượng phải lớn hơn 0');
                return;
            }
            var url = '@Url.Action("Index", "Checkout", new { Area = "Customer" })' + '?bookId=@book.Id&quantity=' + qty;
            window.location.href = url;
        }

        function increaseQty() {
            var input = document.getElementById('qtyInput');
            var val = parseInt(input.value);
            if (!isNaN(val)) input.value = val + 1;
        }
        function decreaseQty() {
            var input = document.getElementById('qtyInput');
            var val = parseInt(input.value);
            if (!isNaN(val) && val > 1) input.value = val - 1;
        }

         // Review Form Submit (Simple Ajax)
        $('#reviewForm').on('submit', function(e) {
            e.preventDefault();
            $.ajax({
                url: '@Url.Action("Submit", "Review", new { Area = "Customer" })',
                type: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message);
                        setTimeout(function() { location.reload(); }, 1500);
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function() {
                    toastr.error('Lỗi khi gửi đánh giá');
                }
            });
        });
    </script>
}
